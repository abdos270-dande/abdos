<script>
  const initialTimer = document.getElementById("initial-timer");
  const drawTimer = document.getElementById("draw-timer");
  const spinningName = document.getElementById("spinning-name");
  const winnerBox = document.getElementById("winner-box");
  const participantsSection = document.getElementById("participants-section");
  const participantCount = document.getElementById("participant-count");
  const participantList = document.getElementById("participant-list");
  const rouletteMachine = document.getElementById("roulette-machine");

  let participants = [];
  let winner = null;

  async function loadWinner() {
    try {
      const res = await fetch("get_winner.php");
      const data = await res.json();
      if (data.name) {
        winner = data.name;
      }
    } catch {
      // لا شيء
    }
  }

  async function loadParticipants() {
    const res = await fetch("get_participants.php");
    const data = await res.json();
    participants = data;
    participantCount.textContent = participants.length;
    participantList.innerHTML += "<ul>" + participants.map(n => `<li>${n}</li>`).join("") + "</ul>";
  }

  async function fetchDrawTime() {
    const res = await fetch("draw_config.php");
    const data = await res.json();
    return new Date(data.start_time).getTime();
  }

  function showWinner(name) {
    rouletteMachine.style.display = "none";
    drawTimer.classList.add("hidden");
    initialTimer.classList.add("hidden");
    winnerBox.style.display = "block";
    winnerBox.textContent = `🎉 الفائز هو: ${name}`;
  }

  function startInitialCountdown(startTime) {
    const drawEndTime = startTime + 5 * 60 * 1000;
    const interval = setInterval(() => {
      const now = Date.now();

      if (winner) {
        clearInterval(interval);
        showWinner(winner);
        return;
      }

      if (now < startTime) {
        const diff = startTime - now;
        const mins = Math.floor(diff / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        initialTimer.textContent = `⏳ تبقى على بداية القرعة: ${mins} دقيقة و ${secs} ثانية`;
      } else if (now < drawEndTime) {
        const diff = drawEndTime - now;
        const mins = Math.floor(diff / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        drawTimer.textContent = `🎲 القرعة تبدأ خلال: ${mins} دقيقة و ${secs} ثانية`;
        initialTimer.classList.add("hidden");
        drawTimer.classList.remove("hidden");
        participantsSection.classList.add("hidden");
        rouletteMachine.style.display = "flex";
        startRoulette(drawEndTime);
        clearInterval(interval);
      } else {
        if (!winner) {
          pickWinner();
        } else {
          showWinner(winner);
          clearInterval(interval);
        }
      }
    }, 1000);
  }

  let spinningInterval;

  function startRoulette(endTime) {
    let index = 0;
    spinningInterval = setInterval(() => {
      spinningName.textContent = participants[index % participants.length];
      index++;
      if (Date.now() >= endTime) {
        clearInterval(spinningInterval);
        pickWinner();
      }
    }, 100);
  }

  function pickWinner() {
    const index = Math.floor(Math.random() * participants.length);
    const name = participants[index];
    winner = name;
    fetch("save_winner.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ winner: name })
    });
    showWinner(name);
  }

  // التشغيل
  loadWinner().then(() => {
    loadParticipants().then(() => {
      fetchDrawTime().then(startInitialCountdown);
    });
  });
</script>
