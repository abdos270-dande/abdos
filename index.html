<script>
  const timerEl = document.getElementById("timer");
  const resultEl = document.getElementById("result");

  async function fetchStatus() {
    const res = await fetch("http://192.168.0.128/sas/lottery_status.php");
    const data = await res.json();

    if (data.status === "done") {
      timerEl.style.display = "none";
      resultEl.classList.remove("hidden");
      resultEl.textContent = `الفائز هو: ${data.winner_name}`;
    } else if (data.status === "pending") {
      const drawTime = new Date(data.draw_time).getTime();
      startCountdown(drawTime);
    }
  }

  function startCountdown(targetTime) {
    const timer = setInterval(async () => {
      const now = new Date().getTime();
      const diff = targetTime - now;

      if (diff <= 0) {
        clearInterval(timer);
        timerEl.textContent = "جاري اختيار الفائز...";
        const res = await fetch("http://192.168.0.128/sas/pick_winner.php");
        const result = await res.json();
        if (result.status === "success") {
          resultEl.classList.remove("hidden");
          resultEl.textContent = `الفائز هو: ${result.winner}`;
          timerEl.style.display = "none";
        } else {
          resultEl.textContent = "جاري التحضير للنتيجة...";
        }
      } else {
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);
        timerEl.textContent = `تبقى على بداية القرعة: ${mins} دقيقة و ${secs} ثانية`;
      }
    }, 1000);
  }

  fetchStatus();
</script>
